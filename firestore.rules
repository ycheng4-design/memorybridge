rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------
    // Memories collection
    // Read: public via share-link (demo access)
    // Write: authenticated users only
    // --------------------------------------------------------
    match /memories/{memoryId} {
      allow read: if true;
      allow create: if request.auth != null
                    && request.resource.data.keys().hasAll(['title', 'created_at', 'owner_uid'])
                    && request.resource.data.owner_uid == request.auth.uid;
      allow update: if request.auth != null
                    && resource.data.owner_uid == request.auth.uid;
      allow delete: if request.auth != null
                    && resource.data.owner_uid == request.auth.uid;

      // Photos sub-collection
      match /photos/{photoId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update: if request.auth != null;
        allow delete: if request.auth != null;
      }

      // Voice recordings sub-collection
      match /voice_recordings/{recordingId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update: if request.auth != null;
        allow delete: if request.auth != null;
      }

      // Embeddings sub-collection (AI vectors â€” backend writes only)
      match /embeddings/{embeddingId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }

    // --------------------------------------------------------
    // Block all other collections explicitly
    // --------------------------------------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
